stages:
  - test
  - build
  - lint

variables:
  GO_VERSION: "1.21"

# Cache Go modules
.go-cache:
  variables:
    GOPATH: $CI_PROJECT_DIR/.go
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - .go/pkg/mod/

# Test job - runs on every push
test:
  stage: test
  image: golang:${GO_VERSION}
  extends: .go-cache
  before_script:
    - go mod download
  script:
    - go test -v -race -coverprofile=coverage.out ./...
    - go tool cover -func=coverage.out
  coverage: '/total:\s+\(statements\)\s+(\d+.\d+)%/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths:
      - coverage.out
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# Build job - verifies the package builds
build:
  stage: build
  image: golang:${GO_VERSION}
  extends: .go-cache
  before_script:
    - go mod download
  script:
    - go build -v ./...
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# Lint job - runs golangci-lint
lint:
  stage: lint
  image: golangci/golangci-lint:latest
  extends: .go-cache
  script:
    - golangci-lint run --timeout 5m
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# Test with multiple Go versions
.test-matrix:
  stage: test
  extends: .go-cache
  before_script:
    - go mod download
  script:
    - go test -v ./...

test:go-1.21:
  extends: .test-matrix
  image: golang:1.21

test:go-1.22:
  extends: .test-matrix
  image: golang:1.22
  allow_failure: true

# Security scan
security:
  stage: test
  image: golang:${GO_VERSION}
  extends: .go-cache
  before_script:
    - go install golang.org/x/vuln/cmd/govulncheck@latest
  script:
    - govulncheck ./...
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"
      changes:
        - go.mod
        - go.sum
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# Generate coverage report in Cobertura format
coverage:
  stage: test
  image: golang:${GO_VERSION}
  extends: .go-cache
  before_script:
    - go mod download
    - go install github.com/boumenot/gocover-cobertura@latest
  script:
    - go test -coverprofile=coverage.out ./...
    - gocover-cobertura < coverage.out > coverage.xml
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
